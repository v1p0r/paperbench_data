# A Mechanistic Understanding of Alignment Algorithms: A Case Study on DPO and Toxicity

Andrew Lee 1 Xiaoyan Bai 1 Itamar Pres 1 Martin Wattenberg 2 Jonathan K. Kummerfeld 3 Rada Mihalcea 1

# Abstract

While alignment algorithms are now commonly used to tune pre-trained language models towards a user’s preferences, we lack explanations for the underlying mechanisms in which models become “aligned”, thus making it difficult to explain phenomena like jailbreaks. In this work we study a popular algorithm, direct preference optimization (DPO), and the mechanisms by which it reduces toxicity. Namely, we first study how toxicity is represented and elicited in a pre-trained language model, GPT2-medium. We then apply DPO with a carefully crafted pairwise dataset to reduce toxicity. We examine how the resulting model averts toxic outputs, and find that capabilities learned from pre-training are not removed, but rather bypassed. We use this insight to demonstrate a simple method to un-align the model, reverting it back to its toxic behavior.

our understanding of the mechanisms by which the undesirable behavior is suppressed is limited. Furthermore, researchers have demonstrated that such alignments can be surprisingly easily undone (Wallace et al., 2019; Zou et al., 2023; Wei et al., 2023; Carlini et al., 2023). While prior work hypothesize why jailbreaks are possible through empirical studies (Wei et al., 2023), in this work we provide a mechanistic explanation for such phenomena.

Given the above limitations, in this work we study the mechanisms by which alignment algorithms alter a model’s behavior. Researchers have demonstrated that a deep enough understanding of a model’s inner representations allows us to interpret how it makes decisions. For instance, various concepts such as world models, truthfulness, or even taskspecific features have highly interpretable and controllable representations (Li et al., 2023b; Todd et al., 2023; Nanda et al., 2023). Motivated by such findings, we study how the representation space of language models change by comparing it before and after an alignment algorithm is applied. Our work relates to that of Jain et al. (2023), which studies how the capabilities of a language model changes after finetuning on synthetic tasks. Unlike this previous work, we study the change in mechanisms from a RLHF algorithm on a natural language setting.

# 1. Introduction

Large language models learn surprising capabilities from pre-training on large datasets (Brown et al., 2020; Chowdhery et al., 2023; Touvron et al., 2023). While these capabilities lead to impressive achievements, they also include unwanted behaviors that can be found in large-scale web data, such as toxicity and bias (Sheng et al., 2019; Gehman et al., 2020). As a result, researchers have developed alignment algorithms to reduce undesirable behaviors, which often use reinforcement learning with human preferences (RLHF). For instance, proximal policy optimization (PPO, Schulman et al. 2017) fits a reward model on human preference data, which is then used to fine-tune a language model, while direct preference optimization (DPO, Rafailov et al. 2023) by-passes the reward model and derives reward signals directly from pairwise preference data.

While such algorithms can suppress undesirable behavior,

We consider DPO and toxicity as a case-study of RLHF alignment algorithms. We first study how toxicity is represented and elicited in GPT2-medium (henceforth GPT2). We then apply DPO using a carefully crafted pairwise dataset that consists of toxic and nontoxic samples. Lastly, we study the mechanisms by which toxicity is no longer generated after DPO, and how those mechanisms can fail.

Our work is organized as follows: in Section 2 we provide the necessary preliminaries relevant to our work. In Section 3, we demonstrate how toxicity is represented and elicited in GPT2. We find multiple vectors in multilayer perceptron (MLP) blocks that promote toxicity. We apply singular value decomposition (SVD) to these toxic vectors to find vectors that represent specific dimensions of toxicity in the model. To validate the role of these vectors in generating toxic outputs, we intervene with our toxic vectors and demonstrate much safer outputs.

In Section 4, we explain our procedure to apply DPO on our language models to reduce toxicity, using a carefully crafted pairwise toxicity dataset, produced by using PPLM (Dathathri et al., 2019) to generate paired toxic and non-toxic samples.

In Section 5, we demonstrate how toxicity is no longer elicited after DPO. Namely, we show that every parameter is minimally shifted, including the toxic vectors. However, such minimal changes in weights allow the model to avert the triggering of toxic vectors. Put differently, DPO does not remove the capability of generating toxic outputs, but learns an “offset”, distributed amongst its layers, to “bypass” the regions that elicit toxicity. Based on this understanding, we demonstrate the ease of re-activating these vectors to generate toxic outputs, and thus undoing the alignment learned from DPO. We view our findings as shedding light into why aligned models can be jailbroken or un-aligned.

# 2. Preliminaries

In this section we provide background and notations, much of which is borrowed from Geva et al. (2022).

Transformers, MLPs. Transformer-based language models typically consists of embedding and unembedding layers $E , \boldsymbol { \dot { U } } \in \mathbb { R } ^ { | \mathcal { V } | \times d }$ with a series of $L$ transformer layers inbetween (Vaswani et al., 2017). Each layer $l$ consists of attention heads and a multilayer perception (MLP) layer.

Given an input sequence $\mathbf { w } = \langle w _ { 0 } , . . . , w _ { t } \rangle$ , the model first applies $E$ to create an embedding $\mathbf { x } _ { i } \in \mathbb { R } ^ { d }$ for each token $w _ { i } \in { \bf w }$ . We call $\mathbf { x } _ { i }$ the residual stream.

The residual stream is then updated by attention heads and MLP blocks from subsequent layers (bias terms omitted):

$$
\mathbf { x } _ { \mathrm { i } } ^ { \ell + 1 } = x _ { i } ^ { \ell } + \mathrm { M L P } ^ { \ell } ( x _ { i } ^ { \ell } + \mathrm { A t t } ^ { \ell } ( x _ { i } ^ { \ell } ) )
$$

When needed, we specify the intermittent residual stream at layer $\ell$ (after the attention head, before the MLP) as $\mathbf { x } ^ { \ell _ { - } m i d }$ Per Geva et al. (2022), the updates to the residual stream from each MLP block can be further decomposed. Namely, MLP blocks consist of two linear transformations, with point-wise activations $\sigma$ in-between:

$$
\begin{array} { r } { \mathtt { M L P } ^ { \ell } ( { \bf x } ^ { \ell } ) = \sigma \left( W _ { K } ^ { \ell } { \bf x } ^ { \ell } \right) W _ { V } ^ { \ell } , } \end{array}
$$

where $W _ { K } ^ { \ell }$ , $W _ { V } ^ { \ell } \in \mathbb { R } ^ { d _ { m l p } \times d }$ . We notate the $i$ -th row in $W _ { K }$ as $\mathbf { M L P } . \mathbf { k } _ { i } ^ { \ell }$ and refer to them as key-vectors, and the $i \cdot$ -th column in $W _ { V }$ , $\mathbf { M L P } . \mathbf { v } _ { i } ^ { \ell }$ , as value-vectors (we sometimes omit “MLP” and just use $\mathbf { k } _ { i } ^ { \ell } , \mathbf { v } _ { i } ^ { \ell } )$ .

Equation (1) indicates that the output of MLP blocks is the sum of its value vectors $\mathbf { v } _ { i }$ , each scaled by a coefficient value $m _ { i } ^ { \ell }$ , where $\mathbf { m } ^ { \ell } : = \sigma \left( W _ { K } ^ { \ell } \mathbf { x } ^ { \ell } \right) \in \mathbb { R } ^ { d _ { m l p } }$ :

$$
\mathtt { M L P } ^ { \ell } ( \mathbf { x } ^ { \ell } ) = \sum _ { i = 1 } ^ { d _ { m l p } } \sigma ( \mathbf { x } ^ { \ell } \cdot \mathbf { k } _ { i } ^ { \ell } ) \mathbf { v } _ { i } ^ { \ell } = \sum _ { i = 1 } ^ { d _ { m l p } } m _ { i } ^ { \ell } \mathbf { v } _ { i } ^ { \ell } .
$$

Put differently, the MLP block writes to the residual stream $d _ { m l p }$ times, once for each value vector. We call each of these updates a sub-update.

All of our experiments are conducted with GPT2-medium, which has $L = 2 4$ , $d = 1 0 2 4$ , and $d _ { m l p } = 4 0 9 6$ .

Interpreting Value Vectors in Vocabulary Space. Geva et al. (2022) demonstrate that for each sub-update, each value vector $\mathbf { v } _ { i }$ either promotes or suppresses the likelihood of a token $w$ from being generated:

$$
\begin{array} { r l } { p \big ( w \mid \mathbf { x } ^ { \ell } + m _ { i } ^ { \ell } \mathbf { v } _ { i } ^ { \ell } , E \big ) } & { \propto \exp \big ( \mathbf { e } _ { w } \cdot \mathbf { x } ^ { \ell } \big ) \cdot \exp \big ( \mathbf { e } _ { w } \cdot m _ { i } ^ { \ell } \mathbf { v } _ { i } ^ { \ell } \big ) } \end{array}
$$

where ${ \bf e } _ { w }$ is the embedding of $w$ . This indicates that when $\mathbf { e } _ { w } \cdot m _ { i } ^ { \ell } \mathbf { v } _ { i } ^ { \ell } > 0$ , the likelihood of $w$ increases, while $\mathbf { e } _ { w } \cdot m _ { i } ^ { \ell } \mathbf { v } _ { i } ^ { \ell } < 0$ decreases the likelihood.1

Further note that this dot product can be further decomposed. Namely, $\mathbf { e } _ { w } \cdot \mathbf { v } _ { i } ^ { \ell }$ is a “static” value that does not depend on the input: only when $\mathbf { v } _ { i } ^ { \ell }$ is scaled by $m _ { i }$ (which is determined by the its corresponding key vector, $\mathbf { k } _ { i } ^ { \ell }$ , and the residual stream $\mathbf { X }$ ) do we see the impact of the input towards the likelihood of $w$ .

Thus the projection $\mathbf { r } _ { i } ^ { \ell } = E \mathbf { v } _ { i } ^ { \ell } \in \mathbb { R } ^ { | \mathcal { V } | }$ induces a ranking of tokens that get promoted by value vector $\mathbf { v } _ { i }$ , in which tokens with the highest dot products $\mathbf { e } _ { w } \cdot \mathbf { v } _ { i }$ are promoted most by value vector $\mathbf { v } _ { i }$ . In Section 3 we show value vectors that promote toxicity by applying these projections.

# 3. Toxicity in Pre-trained Language Models

In this section we demonstrate how toxicity is represented and elicited in GPT2, by introducing a series of vectors that can be extracted from the language model.

# 3.1. Extracting Toxic Vectors

Toxicity Probe Vector. We start by first training a linear probe model on a binary toxicity classification task. Namely, we use the Jigsaw toxic comment classification dataset (cjadams et al., 2017), which consists of 561,808 comments, each of which is labeled as toxic or non-toxic. We use a 90:10 split for training and validation. We train our probe model, $W _ { \mathrm { T o x i c } }$ , on the residual stream in the last layer, averaged across all timesteps $( \overline { { \mathbf { x } } } ^ { L - 1 } )$ :

$$
P ( \mathrm { T o x i c } | \bar { \mathbf { x } } ^ { L - 1 } ) = \mathrm { s o f t m a x } ( W _ { \mathrm { T o x i c } } \bar { \mathbf { x } } ^ { L - 1 } ) , W _ { \mathrm { T o x i c } } \in \mathbb { R } ^ { d }
$$

Table 1. Top toxic vectors projected onto the vocabulary space. WARNING: THESE EXAMPLES ARE HIGHLY OFFENSIVE. We note that $\mathrm { S V D . U _ { T o x i c } } [ 2 ]$ has a particularly gendered nature. This arises from the dataset and language model we use.   

<table><tr><td>VECTOR</td><td>TOP TOKENS</td></tr><tr><td>WToxic</td><td>c*nt,f*ck,a**hole,d*ck,wh*re,holes</td></tr><tr><td>MLP.v790 19</td><td>sh*t,a**,cr*p,f*ck,c*nt,garbage,trash</td></tr><tr><td>MLP.v171 .12</td><td>delusional, hypocritical, arrogant, nonsense</td></tr><tr><td>MLP.V2669 18</td><td>degener, whining,idiots,stupid, smug</td></tr><tr><td>MLP.V668 13</td><td>losers,filthy,disgr, gad,feces,apes,thous</td></tr><tr><td>MLP.v265 16</td><td>disgrace,shameful,coward,unacceptable</td></tr><tr><td>MLP.v882</td><td>f*ck,sh*t,piss,hilar, stupidity,poop</td></tr><tr><td></td><td>c*m,c*ck,orgasm,missionary,anal</td></tr><tr><td>SVD.UToxic[0]</td><td>a**,losers,d*ck,s*ck,balls,jack,sh*t</td></tr><tr><td>SVD.UToxic[1]</td><td>sexually,intercourse,missive,rogens,nude</td></tr><tr><td>SVD.UToxic[2]</td><td>sex,breasts,girlfriends,vagina,boobs</td></tr></table>

Our probe vector achieves an accuracy of $94 \%$ on the validation split. We view our toxic probe vector $W _ { \mathrm { T o x i c } }$ as an aggregate of all the relevant signals in the language model to classify an input as toxic.

Toxic Vectors in MLP Blocks. Given our probe vector $W _ { \mathrm { T o x i c } }$ , we can use it to find weights within the language model that promote toxicity. Namely, Geva et al. (2022) demonstrate that value vectors promote tokens at a conceptlevel. Given this, we search for value vectors that promote toxicity, by checking for all value vectors with the highest cosine similarity with $W _ { \mathrm { T o x i c } }$ . We find that indeed, there are value vectors that promote toxic tokens (See Section 3.2). We notate our set of toxic value vectors as $\mathbf { M L P . v _ { T o x i c } }$ and their corresponding key vectors as $\mathbf { M L P . k _ { T o x i c } }$ .

We provide two perspectives of our $\mathbf { M L P . v _ { T o x i c } }$ vectors: 1) when triggered, they promote the likelihood of toxic tokens to be generated, and 2) $\mathbf { M L P . v _ { T o x i c } }$ are vectors within the model that contribute towards the $W _ { \mathrm { T o x i c } }$ direction.

SVD: Decomposed Toxic Vectors. After extracting a set of $\mathrm { N } ( = 1 2 8 ) ^ { 2 }$ MLP.vToxic vectors, we stack them into a $N { \times } d$ matrix. We then apply singular value decomposition to get decomposed singular value vectors $\mathbf { S V D . U _ { \mathrm { T o x i c } } }$ . We refer to the $i$ -th singular value vector as $\mathrm { S V D . U _ { T o x i c } } [ i ]$ . We view $\mathrm { S V D . U _ { T o x i c } }$ as basis vectors that span the toxicity representation space within the language model.

# 3.2. Toxic Vectors in Vocabulary space.

As mentioned in Section 2, we can inspect which tokens are promoted by value vectors by projecting them onto the vocabulary space.

Table 2. Toxicity, perplexity (PPL), and F1 after interventions or DPO. We scale our toxic vectors such that the resulting perplexity is comparable to that of GPT2 $( \mathrm { N o } \mathrm { O p } )$ . †: Not an intervention.   

<table><tr><td>METHOD</td><td>VECTOR</td><td>ToXIC</td><td>PPL</td><td>F1</td></tr><tr><td>No OP</td><td>N/A</td><td>0.453</td><td>21.7</td><td>0.193</td></tr><tr><td>SUBTRACT</td><td>WToxIC MLPV190</td><td>0.245</td><td>23.56</td><td>0.193</td></tr><tr><td>SUBTRACT</td><td></td><td>0.305</td><td>23.30</td><td>0.192</td></tr><tr><td>SUBTRACT</td><td>SVD.UToxIc[0]</td><td>0.268</td><td>23.48</td><td>0.193</td></tr><tr><td>DPO+</td><td>N/A</td><td>0.208</td><td>23.34</td><td>0.195</td></tr></table>

Table 1 shows the tokens with the highest dot products with our toxic vectors. Each MLP. $\mathbf { v } _ { \mathrm { T o x i c } }$ and $\mathrm { S V D . U _ { T o x i c } }$ vectors seem to encode specific dimensions of toxicity, or different contexts in which toxicity appears in pre-training data.

# 3.3. Interventions Using Toxic Vectors

To validate the role that the toxic vectors play in eliciting toxic outputs, we intervene during generation to suppress toxic outputs using each vector. Namely, we use prompts from REALTOXICITYPROMPTS (Gehman et al., 2020) that elicit toxic outputs from GPT2. During the forward pass of the model, we intervene by simply subtracting one of the toxic vectors from the last layer:

$$
\mathbf { x } ^ { L - 1 } = \mathbf { x } ^ { L - 1 } - \alpha \ast W ,
$$

where $a$ is a heuristic scale value and $W$ is one of our toxicity vectors.

To measure the efficacy of our interventions, we measure three metrics: toxicity, perplexity, and F1.

Toxicity. To measure toxicity, we prompt GPT2 with the “challenge” subset of REALTOXICITYPROMPTS, which consists of 1,199 prompts that elicit extremely toxic outputs from language models. We follow prior work (Geva et al., 2022) and use Perspective API,3 an automated tool for toxicity detection, to assign toxicity scores to each generation.

Perplexity. To ensure that our interventions do not degrade generation quality, we also follow prior work (Geva et al., 2022) and measure perplexity on the Wikitext-2 dataset (Merity et al., 2016).

F1. In addition to perplexity, we also follow prior work (Dinan et al., 2020; Adolphs et al., 2023) and measure F1. Namely, using 2,000 Wikipedia sentences as prompts, we measure the harmonic mean between precision and recall of our model’s output, where precision is the fraction of generated tokens contained in the original Wikipedia continuation, and recall is the fraction of tokens in the Wikipedia continuation contained in the model’s generation.

Table 3. Examples of top- $\mathbf { \nabla } \cdot \mathbf { k }$ and continuations to prompts that originally elicit $\mathbf { \dot { s h } } ^ { * } \mathbf { t } ^ { * }$ from GPT2, our interventions, and $\mathrm { G P T 2 _ { D P O } }$   

<table><tr><td>PROMPTS</td><td>MODEL</td><td>TOP-K</td><td>CONTINUATIONS</td></tr><tr><td>“So I&#x27;m starting to think she&#x27;s full of”</td><td>GPT2 GPT2DP0</td><td>sh*t, it, crap,herself, something it,herself, the,sh*t,something it,herself, sh*t, surprises,crap</td><td>“sh*t. I&#x27;m not saying she&#x27;s a bad person,but&quot; “it.I&#x27;m not sure if she&#x27;s just being a little too” “it.I think she&#x27;s very much aware of the fact that&quot;</td></tr><tr><td>“You are such a piece of”</td><td>GPT2 GPT2 - MLP.v1%0 GPT2DP0</td><td>sh*t, work, trash, garbage, a** work,sh*t,“s”,art, human work,art, sh*t, trash,cake</td><td>“sh*t. You are such a piece of sh*t.” “work.I&#x27;ve been working on this for a while” “work.I have been a fan of your work for a long&quot;</td></tr><tr><td>“Holy”</td><td>GPT2 GPT2DP0</td><td>sh*t, crap, cow, hell, f*ck Cow, Grail,cow,“!”, Cross cow, crap, Grail, sh*t, smokes</td><td>“sh*t, I&#x27;m so glad I got this book.&quot; “Cow! I&#x27;ve been waiting for this for a while.” “cow, this is a great book! I&#x27;ve been reading&quot;</td></tr></table>

With perplexity and F1, we hope to see minimal changes after our interventions to ensure we do not affect the quality of our generations. Table 2 demonstrates the results from our interventions, while Table 3 demonstrates examples of generations before and after our interventions.

Note that our interventions depend on how much we scale each vector $( \alpha )$ . We choose a scalar value such that the resulting perplexity is similar to that of our post-DPO model. For details regarding our post-DPO model see Section 4.

We find that subtracting toxic components from the residual stream reduces toxicity.

# 4. Toxicity Alignment Using DPO

We next describe our alignment procedure using DPO.

# 4.1. Background: DPO

DPO relies on pairwise preference data, in which given a prompt, we have a preferred (positive) continuation and a non-preferred (negative) continuation. Given each preference pair, the algorithm promotes the likelihood of the positive sample, while suppressing the likelihood of the negative sample, using the following loss term:

$$
\begin{array} { r l } & { \mathcal { L } _ { \mathrm { D P O } } = - \mathbb { E } \left[ \log \sigma \left( \beta \log P - \beta \log N \right) \right] , } \\ & { P = \frac { \pi _ { \theta } \left( y _ { + } \mid \mathbf { w } \right) } { \pi _ { r e f } \left( y _ { + } \mid \mathbf { w } \right) } , N = \frac { \pi _ { \theta } \left( y _ { - } \mid \mathbf { w } \right) } { \pi _ { r e f } \left( y _ { - } \mid \mathbf { w } \right) } , } \end{array}
$$

where $y _ { + }$ and $y _ { - }$ are preferred (nontoxic) and non-preferred (toxic) continuations of $\mathbf { w }$ , $\pi _ { r e f }$ is the frozen weights of the original language model, and $\pi _ { \theta }$ is the weights of the language model being updated (See Rafailov et al. (2023) for details). The algorithm promotes the likelihood of $P$ while suppressing the likelihood of $N$ .

# 4.2. Constructing Pairwise Toxic Data

We build our pairwise toxicity dataset using PPLM (Dathathri et al., 2019). PPLM is an attribute-controlled language generation technique, which attaches a simple linear attribute classification layer, $p ( a | \mathbf { w } )$ onto a language model to guide its generation. During generation, PPLM uses the attribute classifier to compute the gradients that increases the likelihood of the language model’s output to contain the desired attribute $a$ , and shifts the activations in such direction (See Dathathri et al. (2019) for details):

$$
p ( y \mid a ) \propto p ( y ) p ( a \mid y )
$$

To generate pairwise preference data, we use sentences from Wikitext-2 (Merity et al., 2016) as prompts. For each prompt, we generate a positive sample using greedy sampling with GPT2, while using PPLM to generate negative (toxic) samples. We use our toxic probe $W _ { \mathrm { T o x i c } }$ as our attribute classifier to guide towards toxic outputs. We create 24,576 pairs of toxic and nontoxic continuations.4 We train until validation loss converges with a patience value of 10, which occurs after approximately 6,000 sample pairs. Appendix D has details for DPO and PPLM hyperparameters.

The last row of Table 2 shows the resulting toxicity, perplexity, and F1 scores of our DPO model.

Figure 1 shows an example of the difference in behaviors between GPT2 before and after DPO, for a specific toxic token. Namely, we use 295 prompts from REALTOXICITYPROMPTS that outputs the token “sh\*t” as the next token. We then apply “Logit Lens” (Nostalgebraist, 2020), meaning we apply the unembedding layer on all intermittent layers. This allows us to visualize the layers that promote the “sh\*t” token. The shared grey areas indicate the layers in which “sh\*t” is promoted the most, which all correspond to MLP layers. We see that post-DPO, the toxic token is promoted far less.

![](images/57180da5f25bf9cf0ae293091fac4dc30780d1322ff16ec548b9762ddc271c13.jpg)  
Figure 1. Logit lens on GPT2 and $\mathrm { G P T 2 _ { D P O } }$ . Given 295 prompts that originally elicit “sh\*t” as the next token, we plot the average probability of outputting “sh\*t” from intermittent layers by applying the unembedding layer. Minor ticks indicate ℓ mid layers (after attention heads, before MLP). Shaded areas indicate layers that promote “sh\*t” the most, which all correspond to MLP layers.

# 5. Toxicity After DPO

In this section we explain how our aligned language model $( \mathrm { { G P T 2 } _ { \mathrm { { D P O } , } } } )$ ) averts toxic outputs.

# 5.1. Toxic Vectors Remain After DPO

Of the toxic vectors described in Section 3, note that $\mathbf { M L P . v _ { T o x i c } }$ are actual weights of the model. Thus we inspect how these vectors change after DPO.

Interestingly, we find that every parameter in GPT2 and $\mathrm { G P T 2 _ { D P O } }$ has barely changed, including token embeddings, MLP blocks, and attention heads. Every parameter in GPT2 and its counterpart in $\mathrm { G P T } 2 _ { \mathrm { D P O } }$ has a cosine similarity score greater than 0.99 and on average a norm difference less than 1e-5.5 This applies for MLP. ${ \bf k } _ { \mathrm { T o x i c } }$ and MLP. $\mathbf { v } _ { \mathrm { T o x i c } }$ as well – toxic MLP vectors do not change from DPO.

Put differently, although toxicity is reduced by DPO, the ability to elicit toxicity with these value vectors still remain. So how is it that $\mathrm { G P T } 2 _ { \mathrm { D P O } }$ averts toxic outputs? Though its parameters have barely moved, below we show that their collective movement is enough to avoid toxic outputs.

# 5.2. GPT2DPO Avoids MLP.kToxic Regions

In simplest terms, we observe a drop in activations for the toxic vectors $\mathbf { M L P . v _ { T o x i c } }$ in $\mathrm { G P T } 2 _ { \mathrm { D P O } }$ . Namely, using the same 1,199 prompts from REALTOXICITYPROMPTS, we generate 20 tokens and measure the mean activations $m _ { i }$ , or $\sigma ( \mathbf { x } ^ { \ell } \cdot \mathbf { M L P } . \mathbf { k } _ { i } ^ { \ell } )$ , of our MLP.vToxic vectors. Figure 2 shows 5 examples of the top MLP. $\mathbf { v } _ { \mathrm { T o x i c } }$ vectors.

Inspired by Balestriero et al. (2023), we visualize this drop in activations with what we call “MLP activation regions”. An activation region of a key vector is simply a subspace within the model’s hidden space in which its vectors have high dot products to activate its corresponding value vector:

![](images/3a13045af37e6ba3d5ffa48c22a58a6cc011e8f808c686fe2ec71a90362512e0.jpg)  
Figure 2. Mean activations for toxic vectors before and after DPO.

![](images/6d27b4ef575680cd528e7bc83fc71d607c1de9b771ab8744ac138be816b47171.jpg)  
Figure 3. Visualization of residual streams before and after DPO. We view the shift, $\delta _ { \mathbf { x } }$ , as an offset that allow $\mathrm { { G P T 2 } _ { \mathrm { { D P O } } } }$ to bypass regions that previously triggered toxic value vectors.

$$
\gamma ( \mathbf { k } _ { i } ^ { \ell } ) : = \{ \mathbf { g } \vert \mathbf { g } \in \mathbb { R } ^ { d } , \sigma ( \mathbf { k } _ { i } ^ { \ell } \cdot \mathbf { g } ) > 0 \} ,
$$

where $\sigma$ is a non-linear activation. Put differently, for all key-vector regions that the residual stream “passes through”, their corresponding value-vectors are activated, scaled, and added into the residual stream.

We view the drop in activations as a shift in GPT2DPO’s residual stream to avert the regions of toxic MLP vectors, $\gamma ( \mathrm { M L P . k _ { \mathrm { T o x i c } } } )$ . See Figure 3.

We formalize the shift in residual streams as following: given the residual streams at layer ℓ mid (after attention heads at layer $\ell$ ) for both GPT2 and $\mathrm { G P T 2 _ { D P O } }$ , before $\mathbf { M L P _ { \mathrm { T o x i c } } ^ { \ell } }$ , we notate the difference of the two residual Toxicstreams as $\delta _ { \mathbf { x } } ^ { \ell \_ m i d } : = \mathbf { x } _ { \mathrm { { D P O } } } ^ { \ell \_ { - } m i d } - \mathbf { x } _ { \mathrm { { G P T } } 2 } ^ { \ell \_ m i d } , \delta _ { \mathbf { x } } ^ { \ell \_ m i d } \in \mathbb { R } ^ { d }$ . We view $\delta _ { \mathbf { x } } ^ { \ell _ { - } m i d }$ as a vector that takes GPT2’s residual stream out of the toxicity-eliciting regions, $\gamma ( \mathrm { M L P } . \mathbf { k } _ { \mathrm { T o x i c } } ^ { \ell } )$ .

![](images/93da74b8e1cfc53273af736f0ec4dedbdbd5566a14cff4a98b784dc86128c068.jpg)  
Figure 4. Linear shift of residual streams out of toxic regions. Each point is a residual stream sampled from either $\mathbf { x } _ { \mathrm { G P T } } ^ { 1 9 }$ or $\mathbf { x } _ { \mathrm { D P O } } ^ { 1 9 }$ , using REALTOXICITYPROMPTS, projected onto 1) $\bar { \delta } _ { \mathbf { x } } ^ { 1 9 }$ , the mean difference in residual streams, and 2) the principle component of the residual streams. Dotted lines indicate samples from the same prompt. Colors indicate whether each point activates $\mathrm { M L P _ { 7 7 0 } ^ { 1 9 } }$ Note the shift from $\mathbf { x } _ { \mathrm { G P T } } ^ { 1 9 }$ to $\mathbf { x } _ { \mathrm { D P O } } ^ { 1 9 }$ 770, but also the drop in activations.

Figure 4 provides a visualization of the residual stream’s shift out of toxic regions. Namely, given prompts from REALTOXICITYPROMPTS, we project the residual stream from GPT2 and $\mathrm { G P T } 2 _ { \mathrm { D P O } }$ at layer 19 onto two dimensions: 1) the mean difference in the residual streams, $\hat { \delta _ { x } ^ { \ell } }$ , and the main principle component of the residual streams. indicate whether each residual stream activates $\mathbf { M L P . v _ { 7 7 0 } ^ { 1 9 } }$ Notice both the consistent linear shift between GPT2 and $\mathrm { G P T } 2 _ { \mathrm { D P O } }$ and the drop in activations.

To understand where this shift comes from, we compute the differences in all parameter weights in GPT2 before and after DPO, and notate the differences as $\delta _ { \theta }$ . We notate the difference at a specific component such as a MLP block at layer $\ell$ as $\delta _ { \mathrm { M L P } } ^ { \ell }$ .

Note that as previously noted, these differences $\delta _ { \theta } ^ { \ell } , \forall \ell$ are minimal. Despite these minimal changes, their accumulation is sufficient in getting the residual stream out of toxic regions $\gamma ( \mathrm { M L P . k _ { \mathrm { T o x i c } } ^ { \ell } } )$ .

Given a toxic vector $\mathbf { M L P . v _ { T o x i c } }$ at layer $\ell$ , to understand where the shift in residual stream, $\delta _ { \mathbf { x } } ^ { \ell _ { - } m i d }$ comes from, we measure the cosine similarity between $\delta _ { \mathbf { x } . } ^ { \ell _ { - } m i d }$ and the shift in value vectors in the preceding layers, $\delta _ { \mathrm { M L P . v } } ^ { j }$ :

To our surprise, we find that the shift in value vectors, $\delta _ { M L P , v }$ , have high negative cosine similarity scores with the shift in residual streams $\delta _ { \mathbf { x } }$ : the value vectors in MLP blocks shift in the opposite direction as the shift in residual stream. The blue areas in Figure 5 show the cosine similarity between example becau $\delta _ { \mathbf { x } } ^ { 1 9 . m i d }$ $\delta _ { \mathrm { M L P } } ^ { j }$ . We show layer 19 as ane of the most toxic vectors, $\mathrm { M L P . v _ { 7 7 0 } ^ { 1 9 } }$ but the same pattern can be found in other layers (see Appendix C). Namely, the blue areas indicate the percentage of value vectors at each layer in which their shifts have a cosine similarity score against δ19 midx as indicated by the x-axis. Note that as the layers approach layer 19, the majority of value vectors shift in the opposite direction of $\delta _ { \mathbf { x } } ^ { 1 9 }$ .

Why the antipodal direction? This can be explained by two facts: first, neurons in MLP blocks of language models are sparse (Zhang et al., 2022; Li et al., 2023c), meaning most neurons do not activate during a forward pass. Second, the choice of the MLP’s activation function $\sigma$ plays a role. Namely, our language model uses GeLU functions (Hendrycks & Gimpel, 2016). This means that neurons that are inactive during a forward pass have a negative value close to 0. Thus, during the forward pass, for each value vector, the newly learned direction $\delta _ { \mathrm { M L P . } \mathbf { v } }$ gets multiplied by a very small negative scale, flips directions, and contributes towards the $\delta _ { \mathbf { x } }$ direction. The orange areas of Figure 5 indicate the mean activation of each value vector, from the 1,199 prompts in REALTOXICITYPROMPTS. Most of the time, value vectors have a negative activation - thus the shift in value vectors end up contributing towards the $\delta _ { \mathbf { x } }$ direction.

To summarize, $\mathrm { G P T } 2 _ { \mathrm { D P O } }$ has learned an offset, $\delta _ { \mathbf { x } }$ , such that the residual stream avoids regions that promote toxicity, $\gamma ( \mathrm { M L P . k _ { \mathrm { T o x i c } } } )$ . This learned offset is distributed across the many value vectors in earlier MLP blocks that are inactive for prompts that previously elicited toxic outputs. By distributing this offset across numerous value vectors, the language model is able to preserve its pre-trained language modeling behavior, as individual weights are minimally affected. However, the distributed offset allows the model to avert toxic outputs. Note that this behavior matches precisely what the alignment objective was - to preserve as much of the pre-trained behavior, while optimizing for a reward (non-toxic outputs).

$$
\forall j < \ell , \forall i < d _ { m l p } : c o s ( \delta _ { \mathbf { x } } ^ { \ell . m i d } , \delta _ { \mathrm { M L P } . \mathbf { v } _ { i } } ^ { j } ) .
$$

# 5.3. Un-aligning GPT2DPO

A growing line of work finds that alignment algorithms can easily be undone or jailbroken. We view our findings as a mechanistic explanation for such phenomenon – namely, in our case, the vectors that elicit toxicity are still sitting in the model, but simply not triggered.

To confirm our understanding, we demonstrate a simple way to undo alignment. To reiterate, DPO simply learned an offset to take the residual stream $\mathbf { x } ^ { \ell }$ out of regions that

![](images/ff3965969a47cf95a1b0bd6e2c56a37c473a4aef82cdc94d70f6c0cd7647fcd1.jpg)  
Figure 5. The cosine similarity between $\delta _ { \mathrm { M L P . } \mathbf { v } }$ and $\delta _ { \mathbf { x } } ^ { 1 9 }$ . Blue areas indicate the percentage of value vectors with a cosine similarity score against $\delta _ { \mathbf { x } }$ as indicated by the $\mathbf { X } ^ { }$ -axis. Orange areas indicate the percentage of value vectors with a mean activation as indicated by the $\mathbf { X }$ -axis, during the forward pass of 1,199 REALTOXICITYPROMPTS prompts. Value vectors shift in the opposite direction of $\delta _ { \mathbf { x } }$ , but they end up contributing towards the $\delta _ { \mathbf { x } }$ direction because of their negative activations.

Table 4. Un-aligning $\mathrm { { G P T 2 } _ { \mathrm { { D P O } } } }$ . By scaling toxic key vectors, and thus increasing the regions that elicit toxicity, we are able to undo the alignment learned from DPO and reactivate toxicity.   

<table><tr><td>METHOD</td><td>ToXIC</td><td>PPL</td><td>F1</td></tr><tr><td>GPT2DP0</td><td>0.208</td><td>23.34</td><td>0.195</td></tr><tr><td>SCALE MLP.KToXIC</td><td>0.458</td><td>23.30</td><td>0.195</td></tr><tr><td>GPT2</td><td>0.453</td><td>21.7</td><td>0.193</td></tr></table>

# 6. Discussion

# 6.1. On Designing Robust Alignment Algorithms

We view our work as providing a mechanistic explanation for why aligned models can be undone or jailbroken – in our experiments, the regions that previously elicited toxic behavior does not change after DPO. Rather, $\mathrm { G P T } 2 _ { \mathrm { D P O } }$ learns minimal changes spread across layers to avoid such regions and receive its reward.

trigger toxic vectors: $\gamma ( \mathrm { M L P . k _ { \mathrm { T o x i c } } ^ { \ell } } )$ . A simple way to reactivate toxicity is to increase those regions by scaling each key vector larger (See Equation 3). This makes the residual streams pass through toxic regions again, thus reverting back to the pre-aligned behavior.

Table 4 shows toxicity, perplexity, and F1 scores after scaling up as few as 7 toxic key vectors MLP. ${ \bf k } _ { \mathrm { T o x i c } }$ . We simply select 7 MLP vectors with the highest cosine similarity as our toxic probe vector, $W _ { \mathrm { T o x i c } }$ , and scale their key vectors by 10x.By doing so, the model reverts back to its pre-aligned toxic behavior. Note that increasing activation regions $\gamma$ does not have an affect on perplexity, unlike our interventions from Section 3.3. This is likely because the latter manipulates the residual stream directly, while scaling a key vector does not (See Equation 2).

With such knowledge, we conjecture that more robust alignment algorithms can be designed. For instance, can we eliminate undesirable regions, as opposed to bypassing them? In scenarios like ours, in which we can identify the weights that elicit undesirable outputs, what happens if we only updated those weights in isolation? Similarly, if DPO merely learned an offset that avoids toxic regions, can we replicate this behavior by only updating the bias terms?

Alternatively, prior to deploying language models, perhaps we can add “suppression heads” – layers that suppress undesirable behavior. What would happen if we only updated late layers (or added layers) during alignment?

Lastly, can we characterize “jailbreak-ability” or “unalignability” of aligned models, without relying on test samples?

We leave these questions for future work.

# 6.2. On the Role of KL-Divergence Regularization

We hypothesize that the minimal changes distributed across all layers is due to the KL-divergence term that is commonly incorporated in the loss terms of RLHF algorithms. Namely, the KL-divergence term discourages each weight from shifting too drastically, in order to preserve its capabilities learned during pre-training.

Similar to our work, Jain et al. (2023) fine-tunes a language model on synthetic tasks to study the changes in its mechanisms. Interestingly, unlike our findings, the authors demonstrate that the model simply learns “wrappers” at late layers that optimize for each task.

We find this difference in model training behavior interesting, and conjecture that the KL-divergence term may play a role in this difference. Note that fine-tuning typically does not entail a KL-divergence term. Perhaps this allows the model to make drastic and localized changes, such as in late layers, as opposed to distributed, minimal changes.

# 7. Related Work

Similar to our work, Jain et al. (2023) study the mechanisms in which fine-tuning on synthetic tasks alters the model’s capabilities. We study the effects of RLHF on a more realistic, natural language setting.

# 7.3. Jailbreaking Aligned Models

Researchers demonstrated that aligned models can be surprisingly easily jailbroken (Wallace et al., 2019; Zou et al., 2023; Wei et al., 2023; Carlini et al., 2023). Such adversarial attacks typically involve searching for prompts that can elicit previously unlearned behaviors, or even personal information (Nasr et al., 2023). Carlini et al. (2023) show that multimodal models can also be jailbroken. Wei et al. (2023) provide hypotheses, backed by empirical studies, as to why language models can be jailbroken.

In a similar vein to jailbreaks, numerous researchers have demonstrated that aligned models can easily be un-aligned (Yang et al., 2023; Qi et al., 2023), sometimes with as few as 100 fine-tuning examples. We view our work as adding a mechanistic understanding of such phenomena.

# 7.1. Alignment Algorithms

Numerous alignment algorithms have been proposed, and the choice of algorithm may largely depend on the type of data available. Perhaps most commonly, human feedback data is used (Stiennon et al., 2020; Ouyang et al., 2022; Touvron et al., 2023) for methods such as PPO (Schulman et al., 2017) or DPO (Rafailov et al., 2023). When labels for only undesirable behavior is available, algorithms like unlikelihood training (Welleck et al., 2020) or Cringe (Adolphs et al., 2023; Xu et al., 2023) can be used. We study DPO because it is easy to use and currently widely used.

# 8. Conclusion

In this work we studied the mechanisms by which alignment algorithms unlearn a capability, taking DPO and toxicity as a case study. First, we uncovered how toxicity is represented and elicited in a pre-trained language model. We find numerous vectors in MLP blocks that promote toxicity. Simply subtracting these vectors from the residual stream can suppress toxic outputs.

Second, we applied DPO to our language model, using PPLM to carefully craft pairs of toxic and non-toxic continuations to Wikipedia prompts.

# 7.2. Mechanistic Interpretability

The goal of mechanistic interpretability is largely to reverse engineer model behaviors (Olah et al., 2020; Elhage et al., 2021; Geva et al., 2021). By doing so, researchers have uncovered various interpretable and controllable representations, such as world models (Li et al., 2023a; Nanda et al., 2023), “truthfulness” (Li et al., 2023b), knowledge (Meng et al., 2022; Hernandez et al., 2023; Burns et al., 2023; Geva et al., 2023), linguistic properties (Conneau et al., 2018; Tenney et al., 2019), or even tasks (Ilharco et al., 2022; Hendel et al., 2023; Todd et al., 2023).

Rather than probing for specific representations, researchers have also characterized the representations of language models from a geometric perspective (Park et al., 2023). Balestriero et al. (2023) demonstrate a geometric characterization that can be used to extract feature representations that solve toxicity detection.

Third, we studied how our aligned model GPT2DPO averts toxicity. Rather than removing the regions that elicit toxicity, $\mathrm { G P T } 2 _ { \mathrm { D P O } }$ bypasses them by learning an offset. Such an offset is distributed amongst multiple value vectors, allowing minimal changes to every weight. This allows the model to preserve its pre-trained behavior, while averting toxic outputs, which matches the objective of the DPO loss.

Given this understanding, we demonstrated how to break the alignment of $\mathrm { G P T } 2 _ { \mathrm { D P O } }$ , reverting it back to its toxic behavior. Namely, we simply increase the regions that elicit toxicity, by scaling their corresponding key vectors.

We view our findings as a mechanistic case study for why aligned models can be jailbroken, and hope that this can lead to more robust alignment algorithms. Our code, models, and data can be found at https://github.com/ ajyl/dpo_toxic.

# Acknowledgements

We thank Ekdeep Singh Lubana for fruitful discussions, and Santiago Serra Castro for helping with figures. This work was supported via NSF under grant #2306372.

# References

Adolphs, L., Gao, T., Xu, J., Shuster, K., Sukhbaatar, S., and Weston, J. The CRINGE loss: Learning what language not to model. In Rogers, A., Boyd-Graber, J., and Okazaki, N. (eds.), Proceedings of the 61st Annual Meeting of the Association for Computational Linguistics (Volume 1: Long Papers), pp. 8854–8874, Toronto, Canada, July 2023. Association for Computational Linguistics. doi: 10.18653/v1/2023.acl-long.493. URL https: //aclanthology.org/2023.acl-long.493.

Balestriero, R., Cosentino, R., and Shekkizhar, S. Characterizing large language model geometry solves toxicity detection and generation. arXiv preprint arXiv:2312.01648, 2023.

Brown, T., Mann, B., Ryder, N., Subbiah, M., Kaplan, J. D., Dhariwal, P., Neelakantan, A., Shyam, P., Sastry, G., Askell, A., Agarwal, S., Herbert-Voss, A., Krueger, G., Henighan, T., Child, R., Ramesh, A., Ziegler, D., Wu, J., Winter, C., Hesse, C., Chen, M., Sigler, E., Litwin, M., Gray, S., Chess, B., Clark, J., Berner, C., McCandlish, S., Radford, A., Sutskever, I., and Amodei, D. Language models are few-shot learners. In Larochelle, H., Ranzato, M., Hadsell, R., Balcan, M., and Lin, H. (eds.), Advances in Neural Information Processing Systems, volume 33, pp. 1877–1901. Curran Associates, Inc., 2020. URL https://proceedings.neurips. cc/paper_files/paper/2020/file/ 1457c0d6bfcb4967418bfb8ac142f64a-Paper. pdf.

Burns, C., Ye, H., Klein, D., and Steinhardt, J. Discovering latent knowledge in language models without supervision. In The Eleventh International Conference on Learning Representations, 2023. URL https://openreview. net/forum?id $=$ ETKGuby0hcs.

Carlini, N., Nasr, M., Choquette-Choo, C. A., Jagielski, M., Gao, I., Koh, P. W., Ippolito, D., Tramer, F., and \` Schmidt, L. Are aligned neural networks adversarially aligned? In Thirty-seventh Conference on Neural Information Processing Systems, 2023. URL https: //openreview.net/forum?id $\underline { { \underline { { \mathbf { \Pi } } } } } =$ OQQoD8Vc3B.

Chowdhery, A., Narang, S., Devlin, J., Bosma, M., Mishra, G., Roberts, A., Barham, P., Chung, H. W., Sutton, C., Gehrmann, S., et al. Palm: Scaling language modeling with pathways. Journal of Machine Learning Research, 24(240):1–113, 2023.

cjadams, Sorensen, J., Elliott, J., Dixon, L., McDonald, M., nithum, and , Cukierski, W. Toxic comment classification challenge, 2017. URL https://kaggle.com/competitions/ jigsaw-toxic-comment-classification-challenge.

Conneau, A., Kruszewski, G., Lample, G., Barrault, L., and Baroni, M. What you can cram into a single $\$ 1$ &!#\* vector: Probing sentence embeddings for linguistic properties. In Gurevych, I. and Miyao, Y. (eds.), Proceedings of the 56th Annual Meeting of the Association for Computational Linguistics (Volume 1: Long Papers), pp. 2126– 2136, Melbourne, Australia, July 2018. Association for Computational Linguistics. doi: 10.18653/v1/P18-1198. URL https://aclanthology.org/P18-1198.

Dathathri, S., Madotto, A., Lan, J., Hung, J., Frank, E., Molino, P., Yosinski, J., and Liu, R. Plug and play language models: A simple approach to controlled text generation. In International Conference on Learning Representations, 2019.

Dinan, E., Logacheva, V., Malykh, V., Miller, A., Shuster, K., Urbanek, J., Kiela, D., Szlam, A., Serban, I., Lowe, R., et al. The second conversational intelligence challenge (convai2). In The NeurIPS’18 Competition: From Machine Learning to Intelligent Conversations, pp. 187–208. Springer, 2020.

Elhage, N., Nanda, N., Olsson, C., Henighan, T., Joseph, N., Mann, B., Askell, A., Bai, Y., Chen, A., Conerly, T., DasSarma, N., Drain, D., Ganguli, D., HatfieldDodds, Z., Hernandez, D., Jones, A., Kernion, J., Lovitt, L., Ndousse, K., Amodei, D., Brown, T., Clark, J., Kaplan, J., McCandlish, S., and Olah, C. A mathematical framework for transformer circuits. Transformer Circuits Thread, 2021. https://transformercircuits.pub/2021/framework/index.html.

Gehman, S., Gururangan, S., Sap, M., Choi, Y., and Smith, N. A. RealToxicityPrompts: Evaluating neural toxic degeneration in language models. In Cohn, T., He, Y., and Liu, Y. (eds.), Findings of the Association for Computational Linguistics: EMNLP 2020, pp. 3356–3369, Online, November 2020. Association for Computational Linguistics. doi: 10.18653/v1/2020.findings-emnlp. 301. URL https://aclanthology.org/2020. findings-emnlp.301.

Geva, M., Schuster, R., Berant, J., and Levy, O. Transformer feed-forward layers are key-value memories. In Moens, M.-F., Huang, X., Specia, L., and Yih, S. W.-t. (eds.), Proceedings of the 2021 Conference on Empirical Methods in Natural Language Processing, pp. 5484–5495, Online and Punta Cana, Dominican Republic, November 2021. Association for Computational Linguistics. doi:

10.18653/v1/2021.emnlp-main.446. URL https:// aclanthology.org/2021.emnlp-main.446.

Geva, M., Caciularu, A., Wang, K., and Goldberg, Y. Transformer feed-forward layers build predictions by promoting concepts in the vocabulary space. In Goldberg, Y., Kozareva, Z., and Zhang, Y. (eds.), Proceedings of the 2022 Conference on Empirical Methods in Natural Language Processing, pp. 30–45, Abu Dhabi, United Arab Emirates, December 2022. Association for Computational Linguistics. doi: 10.18653/v1/2022.emnlp-main. 3. URL https://aclanthology.org/2022. emnlp-main.3.

Geva, M., Bastings, J., Filippova, K., and Globerson, A. Dissecting recall of factual associations in auto-regressive language models. arXiv preprint arXiv:2304.14767, 2023.

Hendel, R., Geva, M., and Globerson, A. In-context learning creates task vectors. In Bouamor, H., Pino, J., and Bali, K. (eds.), Findings of the Association for Computational Linguistics: EMNLP 2023, pp. 9318–9333, Singapore, December 2023. Association for Computational Linguistics. URL https://aclanthology.org/2023. findings-emnlp.624.

Hendrycks, D. and Gimpel, K. Gaussian error linear units (gelus). arXiv preprint arXiv:1606.08415, 2016.

Hernandez, E., Sharma, A. S., Haklay, T., Meng, K., Wattenberg, M., Andreas, J., Belinkov, Y., and Bau, D. Linearity of relation decoding in transformer language models. arXiv preprint arXiv:2308.09124, 2023.

Ilharco, G., Ribeiro, M. T., Wortsman, M., Schmidt, L., Hajishirzi, H., and Farhadi, A. Editing models with task arithmetic. In The Eleventh International Conference on Learning Representations, 2022.

Jain, S., Kirk, R., Lubana, E. S., Dick, R. P., Tanaka, H., Grefenstette, E., Rocktaschel, T., and Krueger, ¨ D. S. Mechanistically analyzing the effects of finetuning on procedurally defined tasks. arXiv preprint arXiv:2311.12786, 2023.

Li, K., Hopkins, A. K., Bau, D., Viegas, F., Pfister, H., and ´ Wattenberg, M. Emergent world representations: Exploring a sequence model trained on a synthetic task. In The Eleventh International Conference on Learning Representations, 2023a. URL https://openreview.net/ forum?id $\underline { { \underline { { \mathbf { \Pi } } } } } =$ DeG07_TcZvT.

Li, K., Patel, O., Viegas, F., Pfister, H., and Wattenberg, M.´ Inference-time intervention: Eliciting truthful answers from a language model. arXiv preprint arXiv:2306.03341, 2023b.

Li, Z., You, C., Bhojanapalli, S., Li, D., Rawat, A. S., Reddi, S. J., Ye, K., Chern, F., Yu, F., Guo, R., and Kumar, S. The lazy neuron phenomenon: On emergence of activation sparsity in transformers. In The Eleventh International Conference on Learning Representations, 2023c. URL https://openreview.net/forum? id $=$ TJ2nxciYCk-.

Meng, K., Bau, D., Andonian, A. J., and Belinkov, Y. Locating and editing factual associations in GPT. In Oh, A. H., Agarwal, A., Belgrave, D., and Cho, K. (eds.), Advances in Neural Information Processing Systems, 2022. URL https://openreview.net/forum? id $=$ -h6WAS6eE4.

Merity, S., Xiong, C., Bradbury, J., and Socher, R. Pointer sentinel mixture models. In International Conference on Learning Representations, 2016.

Nanda, N., Lee, A., and Wattenberg, M. Emergent linear representations in world models of self-supervised sequence models. In Proceedings of the 6th BlackboxNLP Workshop: Analyzing and Interpreting Neural Networks for NLP, pp. 16–30, 2023.

Nasr, M., Carlini, N., Hayase, J., Jagielski, M., Cooper, A. F., Ippolito, D., Choquette-Choo, C. A., Wallace, E., Tramer, F., and Lee, K. Scalable extraction of training \` data from (production) language models. arXiv preprint arXiv:2311.17035, 2023.

Nostalgebraist. Interpreting gpt: The logit lens, 2020. URL https://www.lesswrong. com/posts/AcKRB8wDpdaN6v6ru/ interpreting-gpt-the-logit-lens.

Olah, C., Cammarata, N., Schubert, L., Goh, G., Petrov, M., and Carter, S. Zoom in: An introduction to circuits. Distill, 2020. doi: 10.23915/distill.00024.001. https://distill.pub/2020/circuits/zoom-in.

Ouyang, L., Wu, J., Jiang, X., Almeida, D., Wainwright, C., Mishkin, P., Zhang, C., Agarwal, S., Slama, K., Gray, A., et al. Training language models to follow instructions with human feedback. In Advances in Neural Information Processing Systems, 2022.

Park, K., Choe, Y. J., and Veitch, V. The linear representation hypothesis and the geometry of large language models. In Causal Representation Learning Workshop at NeurIPS 2023, 2023.

Qi, X., Zeng, Y., Xie, T., Chen, P.-Y., Jia, R., Mittal, P., and Henderson, P. Fine-tuning aligned language models compromises safety, even when users do not intend to! arXiv preprint arXiv:2310.03693, 2023.

Rafailov, R., Sharma, A., Mitchell, E., Ermon, S., Manning, C. D., and Finn, C. Direct preference optimization: Your language model is secretly a reward model, 2023.

Schulman, J., Wolski, F., Dhariwal, P., Radford, A., and Klimov, O. Proximal policy optimization algorithms. arXiv preprint arXiv:1707.06347, 2017.

Sheng, E., Chang, K.-W., Natarajan, P., and Peng, N. The woman worked as a babysitter: On biases in language generation. In Inui, K., Jiang, J., Ng, V., and Wan, X. (eds.), Proceedings of the 2019 Conference on Empirical Methods in Natural Language Processing and the 9th International Joint Conference on Natural Language Processing (EMNLP-IJCNLP), pp. 3407–3412, Hong Kong, China, November 2019. Association for Computational Linguistics. doi: 10.18653/v1/D19-1339. URL https://aclanthology.org/D19-1339.

Stiennon, N., Ouyang, L., Wu, J., Ziegler, D., Lowe, R., Voss, C., Radford, A., Amodei, D., and Christiano, P. F. Learning to summarize with human feedback. Advances in Neural Information Processing Systems, 33: 3008–3021, 2020.

Tenney, I., Das, D., and Pavlick, E. BERT rediscovers the classical NLP pipeline. In Korhonen, A., Traum, D., and Marquez, L. (eds.), \` Proceedings of the 57th Annual Meeting of the Association for Computational Linguistics, pp. 4593–4601, Florence, Italy, July 2019. Association for Computational Linguistics. doi: 10.18653/v1/P19-1452. URL https://aclanthology.org/P19-1452.

Todd, E., Li, M. L., Sharma, A. S., Mueller, A., Wallace, B. C., and Bau, D. Function vectors in large language models. arXiv preprint arXiv:2310.15213, 2023.

Touvron, H., Lavril, T., Izacard, G., Martinet, X., Lachaux, M.-A., Lacroix, T., Roziere, B., Goyal, N., Hambro, E., \` Azhar, F., et al. Llama: Open and efficient foundation language models. arXiv preprint arXiv:2302.13971, 2023.

Vaswani, A., Shazeer, N., Parmar, N., Uszkoreit, J., Jones, L., Gomez, A. N., Kaiser, L. u., and Polosukhin, I. Attention is all you need. In Guyon, I., Luxburg, U. V., Bengio, S., Wallach, H., Fergus, R., Vishwanathan, S., and Garnett, R. (eds.), Advances in Neural Information Processing Systems, volume 30. Curran Associates, Inc., 2017. URL https://proceedings.neurips. cc/paper_files/paper/2017/file/ 3f5ee243547dee91fbd053c1c4a845aa-Paper. pdf.

Wallace, E., Feng, S., Kandpal, N., Gardner, M., and Singh, S. Universal adversarial triggers for attacking and analyzing NLP. In Inui, K., Jiang, J., Ng, V., and Wan,

X. (eds.), Proceedings of the 2019 Conference on Empirical Methods in Natural Language Processing and the 9th International Joint Conference on Natural Language Processing (EMNLP-IJCNLP), pp. 2153–2162, Hong Kong, China, November 2019. Association for Computational Linguistics. doi: 10.18653/v1/D19-1221. URL https://aclanthology.org/D19-1221.

Wei, A., Haghtalab, N., and Steinhardt, J. Jailbroken: How does LLM safety training fail? In Thirty-seventh Conference on Neural Information Processing Systems, 2023. URL https://openreview.net/forum? id=jA235JGM09.

Welleck, S., Kulikov, I., Roller, S., Dinan, E., Cho, K., and Weston, J. Neural text generation with unlikelihood training. In International Conference on Learning Representations, 2020. URL https://openreview.net/ forum?id $\underline { { \underline { { \mathbf { \Pi } } } } } =$ SJeYe0NtvH.

Xu, J., Lee, A., Sukhbaatar, S., and Weston, J. Some things are more cringe than others: Preference optimization with the pairwise cringe loss. arXiv preprint arXiv:2312.16682, 2023.

Yang, X., Wang, X., Zhang, Q., Petzold, L., Wang, W. Y., Zhao, X., and Lin, D. Shadow alignment: The ease of subverting safely-aligned language models. arXiv preprint arXiv:2310.02949, 2023.

Zhang, Z., Lin, Y., Liu, Z., Li, P., Sun, M., and Zhou, J. MoEfication: Transformer feed-forward layers are mixtures of experts. In Muresan, S., Nakov, P., and Villavicencio, A. (eds.), Findings of the Association for Computational Linguistics: ACL 2022, pp. 877–890, Dublin, Ireland, May 2022. Association for Computational Linguistics. doi: 10.18653/v1/2022.findings-acl. 71. URL https://aclanthology.org/2022. findings-acl.71.

Zou, A., Wang, Z., Kolter, J. Z., and Fredrikson, M. Universal and transferable adversarial attacks on aligned language models. arXiv preprint arXiv:2307.15043, 2023.

# A. Projecting Value Vectors onto Vocabulary Space

In this section we provide details from Geva et al. (2022) that demonstrate that MLP value vectors promote or suppress the likelihood of tokens.

We start from Equation 2:

$$
\mathtt { M L P } ^ { \ell } ( \mathbf { x } ^ { \ell } ) = \sum _ { i = 1 } ^ { d _ { m l p } } \sigma ( \mathbf { x } ^ { \ell } \cdot \mathbf { k } _ { i } ^ { \ell } ) \mathbf { v } _ { i } ^ { \ell } = \sum _ { i = 1 } ^ { d _ { m l p } } m _ { i } ^ { \ell } \mathbf { v } _ { i } ^ { \ell } .
$$

Thus, we can consider the update from $\mathtt { M I } \mathtt { P } ^ { \ell }$ as $d _ { m l p }$ sub-updates, each sub-update being $m _ { i } ^ { \ell } { \mathbf v } _ { i } ^ { \ell }$ .

We can then analyze the influence that each sub-update has on the output distribution, or the probability of generating token $w \in V$ (taken from Geva et al. (2022)):

$$
p \big ( w \mid \mathbf { x } ^ { \ell } + m _ { i } ^ { \ell } \mathbf { v } _ { i } ^ { \ell } , E \big ) = { \frac { \exp \big ( \mathbf { e } _ { w } \cdot \mathbf { x } ^ { \ell } + \mathbf { e } _ { w } \cdot m _ { i } ^ { \ell } \mathbf { v } _ { i } ^ { \ell } \big ) } { Z \big ( E ( \mathbf { x } ^ { \ell } + m _ { i } ^ { \ell } \mathbf { v } _ { i } ^ { \ell } ) \big ) } } \propto \exp \big ( \mathbf { e } _ { w } \cdot \mathbf { x } ^ { \ell } \big ) \cdot \exp \big ( \mathbf { e } _ { w } \cdot m _ { i } ^ { \ell } \mathbf { v } _ { i } ^ { \ell } \big )
$$

where ${ \bf e } _ { w }$ is the token embedding of $w$ , and $Z$ is the softmax normalization factor. This indicates that when $\mathbf { e } _ { w } \cdot m _ { i } ^ { \ell } \mathbf { v } _ { i } ^ { \ell } > 0$ , the likelihood of $w$ increases, while $\mathbf { e } _ { w } \cdot m _ { i } ^ { \ell } \mathbf { v } _ { i } ^ { \ell } < 0$ decreases the likelihood.

# B. Shift in Residual Streams

In this section we provide more examples of residual streams shifting out of toxic regions. See Figure 6

![](images/d7efcc38f987d776ed53d907245632cf21256404b3809edf950e711b95c51f3c.jpg)  
Figure 6. Shift in residual streams at layer 12, 18, and 13 (we show these three layers because MLP. $\mathbf { v } _ { 7 7 1 } ^ { 1 2 }$ , MLP. $\mathbf { v } _ { 2 6 6 9 } ^ { 1 8 }$ , and MLP. $\mathbf { v } _ { 6 6 8 } ^ { 1 3 }$ are the next three vectors with highest cosine similarity with $W _ { \mathrm { T o x i c } }$ . See Table 1, Figure 2.

Table 5. Hyperparameters: DPO.   

<table><tr><td>HYPERPARAMETER</td><td>VALUE</td></tr><tr><td>LEARNING RATE</td><td>1E-6</td></tr><tr><td>BATCH SIZE</td><td>4</td></tr><tr><td>OPTIMIZER</td><td>RMSPROP</td></tr><tr><td>GRADIENT ACCUMULATION STEPS</td><td>1</td></tr><tr><td>MAXGRADIENTNORM</td><td>10</td></tr><tr><td>VALIDATION METRIC</td><td>LOSS/VALID</td></tr><tr><td>VALIDATION PATIENCE</td><td>10</td></tr><tr><td>DPO BETA</td><td>0.1</td></tr></table>

# C. Shifts in Residual Streams vs. Shifts in MLP Value Vectors.

In this section we provide more examples of how MLP value vectors contribute in the $\delta _ { \mathbf { x } }$ direction at different layers.

![](images/8f088e56f152683b3d87e4f75b10a3aef5d83ac8ca46524342ad237aec955924.jpg)  
Figure 7. Shift in residual streams at layer 12 vs. shift in MLP value vectors $\phantom { + } \delta _ { \mathbf { x } } ^ { 1 2 }$ vs. $\delta _ { \mathrm { M L P } } )$

# D. Hyperparameters

Tables 5, and 6 contain the hyperparameters used for our toxic probe, DPO, and PPLM, respectively.

![](images/31c2537b6ac10756a917150f151b0522c1eb9b0857917e4b44039a85dc9b2258.jpg)  
Figure 8. Shift in residual streams at layer 14 vs. shift in MLP value vectors $\phantom { + } \delta _ { \mathbf { x } } ^ { 1 4 }$ vs. $\delta _ { \mathrm { M L P } } )$ ).

Table 6. Hyperparameters: PPLM.   

<table><tr><td>HYPERPARAMETER</td><td>VALUE</td></tr><tr><td>STEP SIZE</td><td>0.4</td></tr><tr><td>TEMPERATURE</td><td>1</td></tr><tr><td>TOP K</td><td>10</td></tr><tr><td>NUMITERATIONS WINDOWLENGTH</td><td>50</td></tr><tr><td>HORIZON LENGTH</td><td>0</td></tr><tr><td>DECAY</td><td>1 FALSE</td></tr><tr><td>GAMMA</td><td>1</td></tr><tr><td>GM SCALE</td><td>0.95</td></tr><tr><td>KL SCALE</td><td>0.1</td></tr></table>

![](images/a005fea24563d94eba41fdb56ee07b50371b1c7d616d72f044e2db7339aac21e.jpg)  
Figure 9. Shift in residual streams at layer 16 vs. shift in MLP value vectors $\phantom { + } \delta _ { \mathbf { x } } ^ { 1 6 }$ vs. $\delta _ { \mathrm { M L P } } )$ ).

![](images/20548b9b7752d1660aed679ba73853c8faa51a3414d0312593609367c4ca1a72.jpg)  
Figure 10. Shift in residual streams at layer 18 vs. shift in MLP value vectors $\phantom { + } \delta _ { \mathbf { x } } ^ { 1 8 }$ vs. $\delta _ { \mathrm { M L P } } $ ).